<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <meta name = "viewport" content="width=device-width, initial-scale=0.75, user-scalable=no">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.1.6/underscore-min.js"></script>
        
        <script type="text/javascript" src="parse-1.0.20.js"></script>
        <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
        <link rel="stylesheet" href="bootstrap/css/bootstrap-responsive.css" >
        
        <script src="bootstrap/js/bootstrap.js"></script>
        <script type="text/javascript">
            console.log("QuoteBook app started using : "+navigator.appName);
            
            if(navigator.appName == "Microsoft Internet Explorer"){
                alert("This site does not run on IE.");
                window.location="https://www.google.com/chrome/";
            }
        </script>

    </head>

    <body>

        <script type="text/javascript">
        $(function($){
            Parse.initialize('eL5Zl4jRY6fUD3PcmbC6yObE3gSmdwfxShYmkOPi','jfokH6Oa1Cx1PENgS414NUtUPi5UypVTFfGuWQQp');
            
            _.templateSettings = {
                interpolate : /\{\{(.+?)\}\}/g
            };
            
            
            /**
             * Define Views
             */
            var QuoteView = Parse.View.extend({
                initialize: function(){
                    this.model = this.model || new Quote();
                    this.render();
                    console.log('View created: QuoteView');
                },
                lineTemplate: _.template("\
                    <strong>{{who}}</strong>:{{said}}<br>\
                    "),
                template: _.template("\
                    <div>\
                      <blockquote class='QuoteView'>\
                        {{parts}}\
                        <small><i class='icon-world'></i>{{loc}}, {{meta}}</small>\
                      </blockquote>\
                    </div>\
                    "),
                render: function(){
                    // TODO :  There must be a nicer way to do this.
                    var modelJSON = this.model.toJSON();
                    modelJSON.parts = _.reduce(modelJSON.parts, function(memo, part){
                            return memo + this.lineTemplate(part); 
                        }, "", this);
                    var htmlView = this.template(modelJSON);
                    $(this.el).append( htmlView );
                    return htmlView;
                },
                model: null
            });
            
            var EditableQuoteView = Parse.View.extend({
                initialize: function(){
                    this.model = this.model || new Quote();
                    var quotes = this.model;
                    console.log('View created: editablequoteview');
                },
                template: _.template('\
                    <div class="QuoteView">\
                        <input type="text" placeholder="Who"><input type="text" placeholder="Said What...."><a class="btn btn-small btn-info">+</a><a class="btn btn-small btn-info">-</a><br>\
                        <input type="text" placeholder="Where"><input type="text" placeholder="Other info">\
                    </div>\
                    '),
                render: function(){
                    $(this.el).html( this.template(null) );
                    return this;
                },
                model: null
            });
            
            var QuotesListView = Parse.View.extend({
                initialize: function(){
                    this.model = this.model || new Quotes();
                    var quotes = this.model;
                    quotes.on("reset", function(aNewModel){
                        // Got data back from server
                        console.log('Clearing QuotesListView.Model');
                        this.render();
                    }, this);
                    quotes.on("add", function(aNewModel){
                        // Added data locally
                        // Save off to Parse.com
                        console.log('Added Item To QuotesListView.Model');
                        console.log(aNewModel);
                    }, this);
                    quotes.on("remove", function(aNewModel){
                        // Added data locally
                        // Save off to Parse.com
                        console.log('Removed Item From QuotesListView.Model');
                    }, this);
                    console.log('View created: QuoteListView');
                },
                render: function(){
                    $(this.el).empty();
                    this.subViews = [];
                    for (i in this.model.models){
                        var options = {
                            el:this.el,
                            model:this.model.models[i]
                        }
                        this.subViews.push(new QuoteView(options));
                    }
                },
                model: null,
                subViews: []
            });
            
            /**
             * Define models
             */
            var Quote = Parse.Object.extend("Quotes",{
                defaults:{
                    className:'Quote',
                    loc:'a location',
                    meta:'some data',
                    parts:[{"said":"something","who":"person"},{"said":"something else","who":"another person"}]
                }
            }); //Define Quote as a subclass
                        
            var Quotes = Parse.Collection.extend({
              initialize:function(){
                this.fetch({
                        success: function(collection) {
                            //this is now 'window' object
                            console.log('Data back from server');
                        },
                        error: function(collection, error) {
                            console.error('The collection could not be retrieved.');
                        }
                    });
              },
              model: Quote
            });
            
            /**
             * start doing things
             */
             
            /**
             * create a top level object accessable after function has finished
             * This object will act as the application 'controller' and will have 
             * child references to the model and view.
             */
            window.app = {};
            window.app.quotesListModel = new Quotes(); //define instance of quotes Model

            //define a view for the quote list and attatch to DOM
            window.app.mainListView = new QuotesListView({
                el: '#mainListView',
                model: window.app.quotesListModel                
            });

            window.app.newQuoteView = new EditableQuoteView({
                el:'#newQuoteView'
            });

            window.app.aQuote = new QuoteView({
                el:'#singleQuoteView'
            });
            
            Parse.Events.on();
            console.log('Registered all event listeners');
        //end of app
        });
        
        </script>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span2"></div>
                <div id='applicationMainView' class="span10">
                    <!-- some placeholder elements -->
                    <div id='newQuoteView' class="row-fluid">
                        <a class='btn btn-large btn-info'>Add New Quote</a>
                    </div>
                    <div id='mainListView' class="row-fluid"></div>
                    <div id='singleQuoteView' class="row-fluid"></div>
                </div>
            </div>
        </div>
    </body>
</html>